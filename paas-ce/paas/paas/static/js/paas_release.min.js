/**
* Tencent is pleased to support the open source community by making 蓝鲸智云PaaS平台社区版 (BlueKing PaaS Community Edition) available.
* Copyright (C) 2017-2018 THL A29 Limited, a Tencent company. All rights reserved.
* Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
* http://opensource.org/licenses/MIT
* Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/
REL_MANAGER=function(){return{app_del:function(e,a){var t=BLUEKING.config.paas_host()+"release/"+a+"/delete/";art.dialog({title:"删除确认",width:300,icon:"question",lock:!0,content:"<div class='t_s14'>您确定要删除应用“"+a+"”吗?</div>",ok:function(){art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:"正在进行删除操作，请稍后..."}),$.post(t,function(e){e.result?(art.dialog({id:"bktips"}).close(),window.location.href=BLUEKING.config.paas_host()+"app/list/"):art.dialog({id:"bktips",title:"温馨提示",width:340,icon:"error",lock:!0,content:e.message,ok:function(){},okVal:"关闭"})},"json")},cancel:function(){},okVal:"确定",cancelVal:"取消"})},saas_app_del:function(e,a){var t=BLUEKING.config.paas_host()+"saas/"+a+"/delete/";art.dialog({title:"删除确认",width:300,icon:"question",lock:!0,content:"<div class='t_s14'>您确定要删除应用“"+a+"”吗?</div>",ok:function(){art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:"正在进行删除操作，请稍后..."}),$.post(t,function(e){e.result?(art.dialog({id:"bktips"}).close(),window.location.href=BLUEKING.config.paas_host()+"saas/list/"):(art.dialog({id:"bktips"}).close(),art.dialog({id:"bktips",title:"温馨提示",width:340,icon:"error",lock:!0,content:e.message,ok:function(){},okVal:"关闭"}))},"json")},cancel:function(){},okVal:"确定",cancelVal:"取消"})},app_test:function(e,a){if($(e).hasClass("btn-disabled"))return!1;var t=$("#is_use_celery").attr("checked"),s=$("#is_use_celery_beat").attr("checked"),o={is_use_celery:t,is_use_celery_beat:s},l=BLUEKING.config.paas_host()+"release/"+a+"/test/";REL_MANAGER._app_release_task(e,a,l,o,1)},app_online:function(e,a){if($(e).hasClass("btn-disabled"))return!1;var t=$("#is_tips").attr("checked"),s=t?"1":"0",o=$("#features").val(),l=$("#bugs").val(),i={is_tips:s,features:o,bugs:l},n=BLUEKING.config.paas_host()+"release/"+a+"/online/";REL_MANAGER._app_release_task(e,a,n,i,2)},app_offline:function(e,a){var t=$("#t_check").attr("checked"),s=$("#o_check").attr("checked");if($("#offline_form_error").html("").hide(),$(e).hasClass("btn-disabled"))return!1;if(!t&&!s)return $("#offline_form_error").text("请选择下架环境！").show(),!1;var o="all";t&&s?o="all":t?o="test":s&&(o="prod");var l={mode:o},i=BLUEKING.config.paas_host()+"release/"+a+"/offline/";REL_MANAGER._app_release_task(e,a,i,l,3)},_app_release_task:function(e,a,t,s,o){1==o?$("#release_msg_test").parent().parent().hide():2==o?$("#release_msg_pro").parent().parent().hide():$("#release_msg_offline").parent().parent().hide();var l="",i="";i=1==o?"上线部署":2==o?"测试部署":"下架",l='<div class="ml30"><span style="font-size: 16px;margin-left:30px;"><i class="icon-loading mr10"></i>正在提交'+i+"请求，请稍后...</div>",$("#release-flow-before").hide(),$("#tips_info").html(""),$("#tips_info").show(),$("#deploy_input").hide(),$("#release-flow-before").html(l),$("#release-flow-before").show(),$.post(t,{form_data:JSON.stringify(s)},function(t){if(t.result){if(t.result){t.event_id;REL_MANAGER._app_to_poll_task(e,a,t,o,s)}}else{REL_MANAGER.back();var l="";l=1==o?"测试部署":2==o?"上线部署":"下架";var i="<p><span class='icon forbid'></span><strong class='fail'>"+l+"操作执行失败，错误详情：</strong></span><div class='streamline'> <pre>"+t.message+"</pre></div>";1==o?$("#release_msg_test").html(i).parent().parent().show():2==o?$("#release_msg_pro").html(i).parent().parent().show():$("#release_msg_offline").html(i).parent().parent().show(),$("button[n_btn=deploy]").parent().find("span[n_m=run]").remove(),$("button[n_btn=deploy]").show(),$("button[n_btn=deploy]").removeAttr("disabled"),$("button[n_btn=saas_deploy]").removeAttr("disabled")}},"json")},confirm_saas_app_offline:function(e,a){art.dialog({title:"温馨提示",width:340,icon:"warning",lock:!0,content:"<span>您确认下架该应用吗?<br><br>下架后用户将无法访问该应用<br>但应用的数据库依然保留</span>",ok:function(){var t={mode:"prod"},s=BLUEKING.config.paas_host()+"release/"+a+"/offline/";$(e).attr({disabled:"disabled"}),REL_MANAGER._app_release_task(e,a,s,t,3)},okVal:"确认",cancelVal:"取消",cancel:function(){}})},confirm_saas_app_online:function(e,a,t,s){if(s&&"0"!=s&&"1"!=s){var o=$(".import-file-name").text(),l=$(".import-file-name").attr("online_file");art.dialog({title:"温馨提示",width:400,icon:"warning",lock:!0,content:"<span>您确认重新部署该应用吗?<br><br>线上运行版本："+l+"<br>您要部署的版本："+o+"</span>",ok:function(){REL_MANAGER.saas_app_online(e,a,t)},okVal:"确认",cancelVal:"取消",cancel:function(){}})}else REL_MANAGER.saas_app_online(e,a,t)},saas_app_online:function(e,a,t){$(e).attr({disabled:"disabled"});var s=BLUEKING.config.paas_host()+"saas/"+a+"/release/online/"+t+"/";tips_msg='<div class="ml30"><span style="font-size: 16px;margin-left:30px;"><i class="icon-loading mr10"></i>正在提交部署请求，请稍后...</div>',$("#release-flow-before").hide(),$("#tips_info").html(""),$("#tips_info").show(),$("#deploy_input").hide(),$("#release-flow-before").html(tips_msg),$("#release-flow-before").show(),$("#release_msg_pro").parent().parent().hide(),$.post(s,function(a){if(a.result){if(a.result){var t=(a.event_id,a.app_code);REL_MANAGER._app_to_poll_task(e,t,a,2,{})}}else{REL_MANAGER.back();var s="<p><span class='icon forbid'></span><strong class='fail'>部署操作执行失败，错误详情：</strong></span><div class='streamline'> <pre>"+a.message+"</pre></div>";$("#release_msg_pro").html(s).parent().parent().show(),$("#saas_app_online").removeAttr("disabled")}},"json")},_app_to_poll_task:function(e,a,t,s,o){var l="";l=BLUEKING.config.paas_host()+"release/"+a+"/task/",$.get(l,{event_id:t.event_id,app_state:s},function(l){data=l.data,html_data=data.html,$("#release-flow").html(html_data),!1===$("#release-flow-before").is(":hidden")&&$("#release-flow-before").hide(),$("#release-flow").is(":hidden")&&$("#release-flow").show(),0===data.status?REL_MANAGER._app_operate_fail(e,a,data,s,o):1==data.status?REL_MANAGER._app_operate_success(e,a,data,s,o):window.setTimeout(function(){REL_MANAGER._app_to_poll_task(e,a,t,s,o)},2e3)},"json")},_app_operate_fail:function(e,a,t,s,o){$("button[n_btn=saas_deploy]").removeClass("disabled"),$("button[n_btn=saas_deploy]").removeAttr("disabled")},_app_operate_success:function(e,a,t,s,o){if($("#deploy_apply div[apply]").hide(),$("#error_dev").html(""),$("#app_del").remove(),REL_MANAGER.refresh_app_state(e,s,t,o),BASE_APP.refresh_app_status(a),$("textarea[name=features], textarea[name=bugs]").val(""),$("#is_tips").removeAttr("checked"),$(".appstate").html(""),$("button[n_btn=deploy]").removeClass("disabled"),$("button[n_btn=deploy]").removeAttr("disabled"),1==s)REL_MANAGER._modify_online_state("show"),REL_MANAGER._modify_offline_state("show");else if(2==s)REL_MANAGER._modify_online_state("hide",!1,'<span aria-hidden="true" class="glyphicon glyphicon-info-sign"></span>应用已上线，请重新测试部署后，再执行正式部署操作！'),REL_MANAGER._modify_offline_state("show");else{var l=o.mode,i=$("#t_check"),n=$("#o_check");"all"==l?(i.attr("checked",!1),i.attr("disabled",!0),n.attr("checked",!1),n.attr("disabled",!0)):"test"==l?(i.attr("checked",!1),i.attr("disabled",!0)):"prod"==l&&(n.attr("checked",!1),n.attr("disabled",!0)),i.attr("disabled")&&n.attr("disabled")&&($(e).addClass("btn-disabled"),REL_MANAGER._modify_offline_state("hide")),"all"!=l&&"prod"!=l||REL_MANAGER._modify_online_state("hide",!1,'<span aria-hidden="true" class="glyphicon glyphicon-info-sign"></span>应用已下架，请您重新测试部署后，再进行正式部署操作！')}},_modify_online_state:function(e,a,t){"hide"==e?(a||($("#deploy_tab li[data-id=online_form]").addClass("disabled_status"),$("#deploy_tab li[data-id=online_form] span").show(),$("#deploy_tab li[data-id=online_form] a").attr("title","请重新测试部署后，再进行正式部署！")),$("#app_online, #create_new_ver").addClass("disabled"),$("#app_online").removeAttr("id"),$("#create_new_ver").removeAttr("id"),$("#online_form_error").html(t).show()):"show"==e&&($("#deploy_tab li[data-id=online_form]").removeClass("disabled_status"),$("#deploy_tab li[data-id=online_form] a").removeAttr("title"),$("#deploy_tab li[data-id=online_form] span").hide())},_modify_offline_state:function(e){"show"==e?($("#deploy_tab li[data-id=offline_form]").removeClass("disabled_status"),$("#deploy_tab li[data-id=offline_form] a").removeAttr("title"),$("#deploy_tab li[data-id=offline_form] span").hide()):"hide"==e&&($("#deploy_tab li[data-id=offline_form]").addClass("disabled_status"),$("#deploy_tab li[data-id=offline_form] a").attr("title","请测试部署后，再进行正式部署"),$("#deploy_tab li[data-id=offline_form] span").show())},refresh_app_state:function(e,a,t,s){if(1==a)$("#test_state").html('<a href="'+t.app_test_url+'" target="_blank"><span aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span>马上访问</a>'),$("span[name_state=test]").text("正在运行").removeClass("status_normal").addClass("status_success");else if(2==a)$("#pro_state").html('<a href="'+t.app_prod_url+'" target="_blank"><span aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span>马上访问</a>'),$("span[name_state=pro]").text("正在运行").removeClass("status_normal").addClass("status_success");else{var o=s.mode;"test"!=o&&"all"!=o||($("#test_state").html('<span class="glyphicon glyphicon-chevron-right ml40" style="color:#999;" data-toggle="tooltip" data-placement="right" title="应用未进行测试部署或者已经下架，访问入口关闭！"></span>马上访问'),$("span[name_state=test]").text("已下架").removeClass("status_success").addClass("status_normal")),"prod"!=o&&"all"!=o||($("#pro_state").html('<span class="glyphicon glyphicon-chevron-right ml40" style="color:#999;" data-toggle="tooltip" data-placement="right" title="应用未进行上线部署或者已经下架，访问入口关闭！"></span>马上访问'),$("span[name_state=pro]").text("已下架").removeClass("status_success").addClass("status_normal"))}},back:function(){$("#release-flow-before").hide(),$("#release-flow").hide(),$("#detail_log").hide(),$("#detail_button").hide(),$("#detail_click").html("点击查看详情"),$("#tips_info").hide(),$("#deploy_input").show()},back_saas:function(){window.location.href=BLUEKING.config.paas_host()+"saas/list/"},get_app_release_detail:function(){if($("#detail_log").is(":hidden")){$("#detail_log").show();var e=$("#detail_info")[0].scrollHeight;$("#detail_info").scrollTop(e),$("#detail_click").html("点击隐藏详情")}else $("#detail_log").hide(),$("#detail_click").html("点击查看详情")},refresh_roll:function(e,a,t,s,o){var l=BLUEKING.config.paas_host()+"release/"+e+"/record/last_release/";$.get(l,{},function(a){a.result&&(data=a.data,REL_MANAGER._app_to_poll_task(null,e,data,o,{}))},"json")},deploy_tab_show:function(e,a,t,s,o,l,i,n){var r=a;if(e.hasClass("disabled_status"));else{var d=e.attr("data-id"),_=BLUEKING.config.paas_host()+"release/"+t+"/deploy_page/"+d+"/";$("#"+d).html('<div style="text-align: center;margin-top:50px;opacity:0.2;filter:alpha(opacity=20);"><img src="'+n+'img/base/icon32_loading_light1e5b3a.gif"></div>'),$.get(_,function(e){$("#"+d).html(e),8!=s&&9!=s&&10!=s||r&&($("#release-flow-before").hide(),$("#tips_info").html(""),$("#deploy_input").hide(),REL_MANAGER.refresh_roll(t,s,o,l,i))}),$("#deploy_tab").find(".active").removeClass("active"),e.addClass("active"),$(".deploy_content").find("div[n_form]").hide(),$("#"+d).show()}return r},search_app_record:function(e,a){var t=BLUEKING.config.paas_host()+"release/"+e+"/record/list/"+a+"/";$.get(t,function(e){$("#record_list").html(e)})},pub_record_show:function(e){var a=e.next("tr");if("detail"==a.attr("class")){var t=$(a).is(":hidden"),s=e.find("i");t?(e.next("tr").css("display",""),s.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up")):(e.next("tr").css("display","none"),s.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"))}},check_unfinished_task:function(e){var a=BLUEKING.config.paas_host()+"release/"+e+"/task/unfinished/";$.get(a,function(e){})},check_use_celery:function(e){e||art.dialog({title:"温馨提示",width:340,icon:"warning",lock:!0,content:"<font style='color:red;'>您确认该应用没有使用celery吗？取消celery部署后，应用相关celery功能将不能使用！</font>",ok:function(){$("#is_use_celery_beat").removeAttr("checked")},okVal:"确认",cancelVal:"关闭",cancel:function(){$("#is_use_celery").attr("checked","checked")}})},check_use_celery_beat:function(e){e?$("#is_use_celery").attr("checked","checked"):art.dialog({title:"温馨提示",width:340,icon:"warning",lock:!0,content:"<font style='color:red;'>取消“周期性任务”部署，已有周期性任务执行将会失效！您确认取消“周期性任务”部署吗？</font>",ok:function(){},okVal:"确认",cancelVal:"关闭",cancel:function(){$("#is_use_celery_beat").attr("checked","checked")}})}}}();