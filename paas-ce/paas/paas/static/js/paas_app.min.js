/**
* Tencent is pleased to support the open source community by making 蓝鲸智云PaaS平台社区版 (BlueKing PaaS Community Edition) available.
* Copyright (C) 2017-2018 THL A29 Limited, a Tencent company. All rights reserved.
* Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
* http://opensource.org/licenses/MIT
* Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/
APP_PROFILE=function(){return{change_password:function(){$(".error_tip").hide(),$(".password_input").val(""),$("#password_tip").text(""),art.dialog({id:"bktips",title:"重置密码",lock:!0,width:500,content:$("#change_password_div").get(0),cancelVal:"取消",cancel:function(){},okVal:"重置密码",ok:function(){var t=!0;if($(".error_tip").hide(),$("#pattern_tip").css("color","black"),$(".password_input").each(function(){var a=$.trim($(this).val());return a?a.match(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])[A-Za-z0-9!@#\$%\^\*\(\)-_\+=]{8,20}$/)||"password1"!=$(this).attr("name")?void 0:($("#pattern_tip").css("color","red"),$(this).focus(),t=!1,!1):($(this).next(".error_tip").show(),$(this).focus(),t=!1,!1)}),!t)return!1;var a=$.trim($("#id_old_password").val()),e=$.trim($("#id_password1").val().trim()),s=$.trim($("#id_password2").val().trim());if(e!=s&&($("#password_tip").text("两次输入的新密码不一致"),t=!1),!t)return!1;var r=BLUEKING.config.paas_host()+"accounts/user/password/",c=!0;if($.ajax({type:"POST",url:r,data:{old_password:a,new_password1:e,new_password2:s},success:function(t){t.result||($("#password_tip").text(t.message),c=!1)},dataType:"json",async:!1}),!c)return!1;art.dialog({width:300,icon:"succeed",lock:!0,content:"密码重置成功"}).time(1),window.location.href="/accounts/logout/"}})},show_modify_user:function(){var t=BLUEKING.config.paas_host()+"accounts/user/info/";$.get(t,{},function(t){art.dialog({id:"bktips",title:"修改个人信息",lock:!0,width:500,content:t})})},modify_user_info:function(){var t=$.trim($("#chname").val());if(!t.match(/^[\u4e00-\u9fa5a-zA-Z0-9_]{1,16}$/))return $("#error_tip").html('中文名只能包含数字、字母、中文汉字、<br><span style="margin-left:105px">下划线，长度在1-16个字符</span>'),$("#chname").focus(),!1;var a=$.trim($("#phone").val());if(!a.match(/^\d{11}$/))return $("#error_tip").text("仅支持中国大陆手机号码（11位数字）"),$("#phone").focus(),!1;var e=$.trim($("#email").val());if(!e.match(/^[A-Za-z0-9]+([-_.][A-Za-z0-9]+)*@([A-Za-z0-9]+[-.])+[A-Za-z0-9]{2,5}$/))return $("#error_tip").text("请输入正确的邮箱格式"),$("#email").focus(),!1;var s=site_url+"accounts/user/info/";$.post(s,{chname:t,phone:a,email:e},function(t){t.result?(art.dialog({id:"bktips"}).close(),art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:"用户信息修改成功"}),setTimeout(window.location.reload(),1e3)):$("#error_tip").text(t.message)},"json")},cancel_edit:function(){art.dialog({id:"bktips"}).close()}}}(),APP_LIST=function(){return{_callback_fun:function(){var t=$("#table_app thead").attr("total_app");$("#total_app").text(t),void 0!==t&&(0==parseInt(t)?($("#page").hide(),$("#app_num_div").hide(),$("#app_num").text(t)):($("#page").show(),$("#app_num_div").show(),$("#app_num").text(t)))},search_app:function(){var t=$.trim($("#search_app").val());if(-1!=t.indexOf("&"))return void art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:"错误的搜索参数! 参数中不能包含符号[&]"});var a=($("#status").val(),$("#set_hide_offline").val()),e={url:BLUEKING.config.paas_host()+"app/list/query/?keyword="+t+"&hide_offline="+a+"&",items_per_page:8,current_page:1,callback:APP_LIST._callback_fun,table_obj:"#table_app"};$("#pagination_id").pagination(e)},clear_search_input:function(){$("#search_app").val(""),$("#close_span").css("display","none"),$("#j_display_all_app").click()}}}(),APP_CREATE=function(){return{_check_app_code:function(){var t=!1;return $.ajax({type:"GET",url:BLUEKING.config.paas_host()+"app/check/app_code/",data:{app_code:$.trim($("#code").val())},success:function(a){a.result?t=!0:($("#tip_code").html(a.message),t=!1)},dataType:"json",async:!1}),t},_check_app_name:function(){var t=!1;if("modify"==$("#name").attr("operation"))var a=$.trim($("#name").val());else var a="";return $.ajax({type:"GET",url:BLUEKING.config.paas_host()+"app/check/app_name/",data:{name:$.trim($("#name").val()),old_name:a},success:function(a){a.result?t=!0:($("#tip_name").html(a.message),t=!1)},dataType:"json",async:!1}),t},check_app_code:function(t){var a=!0;if(""==$.trim($("#code").val()))$("#tip_code").html("请填写应用 ID"),a=!1;else{var e=APP_CREATE._check_app_code();a=e,e&&$("#tip_code").html("")}return a||1!=t||$("#code").focus(),a},check_app_name:function(t){var a=!0;if(""==$.trim($("#name").val()))$("#tip_name").html("请填写应用名称"),a=!1;else{var e=APP_CREATE._check_app_name();a=e,e&&$("#tip_name").html("")}return a||1!=t||$("#name").focus(),a},check_introduction:function(t){var a=!0;return""==$.trim($("#introduction").val())?($("#tip_introduction").html("请填写应用简介"),a=!1):UTILS.chkstrlen($.trim($("#introduction").val()))>30?($("#tip_introduction").html("长度不能超过30个字符"),a=!1):$("#tip_introduction").html(""),a||1!=t||$("#introduction").focus(),a},check_developer:function(t){var a=!0;return""==$.trim($("#developer").val())?($("#tip_developer").html("请填写开发负责人"),a=!1):$("#tip_developer").html(""),a||1!=t||$("#developer").select2("open"),a},check_vcs_url:function(t){var a=!0,e=$.trim($("#vcs_url").val()),s=$("input[name='vcs_type']:checked").val();if(s||(s=$("#vcs_type_id").val()),"0"==s)var r=new RegExp("(http[s]{0,1}|git)://","gi");else var r=new RegExp("(http[s]{0,1}|svn)://","gi");return e.match(r)?$("#tip_vcs_url").html(""):($("#tip_vcs_url").html("请填写正确的仓库地址"),a=!1),a||1!=t||$("#vcs_url").focus(),a},check_vcs_username:function(t){var a=!0;return""==$.trim($("#vcs_username").val())?($("#tip_vcs_username").html("请填写账号"),1==t&&$("#vcs_username").focus(),a=!1):$("#tip_vcs_username").html(""),a},check_vcs_password:function(t){var a=!0;return""==$.trim($("#vcs_password").val())?($("#tip_vcs_password").html("请填写密码"),1==t&&$("#vcs_password").focus(),a=!1):$("#tip_vcs_password").html(""),a},check_app_tags:function(){var t=!0;return""==$.trim($("#app_tags").val())&&(t=!1),t},check_db_host:function(){var t=!0;return $.trim($("#db_host").val())?$("#tip_db_host").html(""):($("#tip_db_host").html("请填写HOST"),t=!1),t},check_db_port:function(){var t=!0,a=$.trim($("#db_port").val());return UTILS.isInt(a)?$("#tip_db_port").html(""):($("#tip_db_port").html("请填写端口，必须为数字"),t=!1),t},check_db_username:function(){var t=!0;return $.trim($("#db_username").val())?$("#tip_db_username").html(""):($("#tip_db_username").html("请填写数据库用户名"),t=!1),t},validate_form:function(){$(".tips").text("");return!!APP_CREATE.check_app_code(1)&&(!!APP_CREATE.check_app_name(1)&&(!!APP_CREATE.check_introduction(1)&&(!!APP_CREATE.check_developer(1)&&(!!APP_CREATE.check_vcs_url(1)&&(!!APP_CREATE.check_vcs_username(1)&&(!!APP_CREATE.check_vcs_password(1)&&($("button").attr("disabled","disabled"),art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:"正在创建应用，请稍后..."}),!0)))))))}}}(),APP_INFO=function(){return{save_base_info:function(){var t=!1;if(!(t=APP_CREATE.check_app_name()))return!1;if(!(t=APP_CREATE.check_developer()))return!1;var a=$("#app_code_id").val(),e=BLUEKING.config.paas_host()+"app/"+a+"/";return $.ajax({type:"POST",url:e,data:{operate:"base",name:$.trim($("#name").val()),developer:$.trim($("#developer").val()),app_tags:$.trim($("#app_tags").val())},success:function(a){t=a.result,t?$("#app_tags_dis").html($("#app_tags option[value="+$("#app_tags").val()+"]").text()):$("#tip_name").html(a.message)},dataType:"json",async:!1}),t},get_vcs_password:function(){var t=$("#app_code_id").val(),a="",e=BLUEKING.config.paas_host()+"app/"+t+"/vcs/password/";return $.ajax({type:"GET",url:e,data:{},success:function(t){a=t.data.password},dataType:"json",async:!1}),a},save_introduction:function(){var t=!1;if(!(t=APP_CREATE.check_introduction()))return!1;var a=$("#app_code_id").val(),e=BLUEKING.config.paas_host()+"app/"+a+"/";return $.ajax({type:"POST",url:e,data:{operate:"introduction",introduction:$.trim($("#introduction").val())},success:function(a){(t=a.result)||$("#tip_introduction").html(a.message)},dataType:"json",async:!1}),t},save_vcs:function(){var t=!1;if(!(t=APP_CREATE.check_vcs_url()))return!1;if(!(t=APP_CREATE.check_vcs_username()))return!1;if(!(t=APP_CREATE.check_vcs_password()))return!1;var a=$("#app_code_id").val(),e=BLUEKING.config.paas_host()+"app/"+a+"/";return $.ajax({type:"POST",url:e,data:{operate:"vcs",vcs_type:$("#vcs_type_id").val(),vcs_url:$.trim($("#vcs_url").val()),vcs_username:$.trim($("#vcs_username").val()),vcs_password:$.trim($("#vcs_password").val())},success:function(a){(t=a.result)||$("#tip_vcs").html(a.message)},dataType:"json",async:!1}),t},save_db_info:function(){var t=!1;if(!(t=APP_CREATE.check_db_host()))return!1;if(!(t=APP_CREATE.check_db_port()))return!1;if(!(t=APP_CREATE.check_db_username()))return!1;var a=$("#app_code_id").val(),e=BLUEKING.config.paas_host()+"app/"+a+"/";return $.ajax({type:"POST",url:e,data:{operate:"db",db_type:$("#db_type_id").val(),db_host:$.trim($("#db_host").val()),db_port:$.trim($("#db_port").val()),db_username:$.trim($("#db_username").val()),db_password:$.trim($("#db_password").val())},success:function(a){(t=a.result)||$("#tip_db").html(a.message)},dataType:"json",async:!1}),t},get_access_info:function(t){var a=BLUEKING.config.paas_host()+"app/"+t+"/status/";$.get(a,{},function(t){data=t.data,app_test_url=data.app_test_url,app_prod_url=data.app_prod_url,1==data.status||2==data.status?$("#test_access_span").html('<a href="'+app_test_url+'" target="_blank" >'+app_test_url+"</a>"):$("#test_access_span").html('<span data-toggle="tooltip" data-placement="top" title="应用未提测或已下架">'+app_test_url+"</span>"),1==data.status||3==data.status?$("#prod_access_span").html('<a href="'+app_prod_url+'" target="_blank" >'+app_prod_url+"</a>"):$("#prod_access_span").html('<span data-toggle="tooltip" data-placement="top" title="应用未上线或已下架">'+app_prod_url+"</span>")},"json")}}}(),$("#show_password_change").on("click",APP_PROFILE.change_password),$("#show_modify_user").on("click",APP_PROFILE.show_modify_user),$("#set_hide_offline").on("change",APP_LIST.search_app),$("#j_display_all_app").on("click",APP_LIST.search_app),$("#close_span").on("click",APP_LIST.clear_search_input),$("#search_app").keyup(function(t){$.trim($("#search_app").val())?$("#close_span").css("display",""):$("#close_span").css("display","none"),"13"==t.keyCode&&$("#j_display_all_app").click()}),$("input[name='code']").on("blur",APP_CREATE.check_app_code),$("input[name='name']").on("blur",APP_CREATE.check_app_name),$("input[name='introduction']").on("blur",APP_CREATE.check_introduction),$("input[name='vcs_url']").on("blur",APP_CREATE.check_vcs_url),$("input[name='vcs_username']").on("blur",APP_CREATE.check_vcs_username),$("input[name='vcs_password']").on("blur",APP_CREATE.check_vcs_password),$("input[name='db_host']").on("blur",APP_CREATE.check_db_host),$("input[name='db_port']").on("blur",APP_CREATE.check_db_port),$("input[name='db_username']").on("blur",APP_CREATE.check_db_username),$(".can_a").click(function(){$(this).hide(),$(this).next(".operate").attr({data:"0"}),$(this).next(".operate").html("编辑");var t=$(this).next(".operate").attr("edit-class");"base"==t&&$("#developer_div").hide(),$(".col_main ."+t).each(function(){var t=$(this).text();$(this).show(),$(this).prev(".app-edit").hide(),$(this).parents(".app-info").find(".app-info-tips").text(""),"vcs_password_value"==$(this).attr("id")?($(".password_show").show(),$(".password_show").attr("data","0"),$(".password_show").attr("title","显示密码"),$(".password_show").html('<i class="bk-icon icon-eye t_b t_s12" style="transform: scale(0.8,0.8);"></i>'),$(this).prev(".app-edit").val("")):$(this).prev(".app-edit").val(t)})}),$(".operate").click(function(){var t=$(this).attr("data"),a=$(this).attr("edit-class");if("0"==t)switch($(this).attr({data:"1"}),$(this).html("保存"),$(this).prev(".can_a").show(),$(".col_main ."+a).hide(),$("."+a).prev(".app-edit").show(),a){case"base":$("#developer_div").show(),$("#app_tags_div").show();break;case"vcs":case"db":$("."+a).prev(".app-edit").css("display","inline-block"),$(".password_show").hide()}else{var e=!1;switch(a){case"base":e=APP_INFO.save_base_info();break;case"introduction":e=APP_INFO.save_introduction();break;case"vcs":e=APP_INFO.save_vcs();break;case"db":e=APP_INFO.save_db_info()}e&&($(this).attr({data:"0"}),$(this).html("编辑"),$(this).prev(".can_a").hide(),$("."+a).prev(".app-edit").hide(),"base"==a&&($("#developer_div").hide(),$("#app_tags_div").hide()),$(".col_main ."+a).each(function(){var t=$.trim($(this).prev(".app-value").val());$(this).show(),"vcs_password_value"==$(this).attr("id")?($(this).html("******"),$(this).prev(".app-value").val(""),$(".password_show").show(),$(".password_show").attr("data","0"),$(".password_show").attr("title","显示密码"),$(".password_show").html('<i class="bk-icon icon-eye t_b t_s12" style="transform: scale(0.8,0.8);"></i>')):$(this).text(t)}))}}),$("#developer_select").select2({placeholder:"负责人，可选多个"}).on("change",function(t){var a=t.val.join(";");$("#developer").val(a)}),$("input[name='vcs_type']").click(function(){"0"==$(this).val()?($("#vcs_url_help").html("支持以下协议：http(s)://, git://"),$("#vcs_type_help").html("通过Git方式获取应用代码"),$("#cur_protocol").val(""),$("#vcs_text").text("Git")):($("#vcs_url_help").html("支持以下协议：http(s)://, svn://<br>请确保 <code>requirements.txt</code> 文件在该目录下"),$("#vcs_type_help").html("通过SVN方式获取应用代码"),$("#cur_protocol").val("svn://"),$("#vcs_text").text("SVN"))}),$(".password_show").click(function(){if("0"==$(this).attr("data")){$(this).attr("data","1");var t=APP_INFO.get_vcs_password();$("#vcs_password_value").html(t),$(this).attr("title","隐藏密码"),$(this).html('<i class="bk-icon icon-eye-slash t_b t_s12" style="transform: scale(0.8,0.8);"></i>')}else $("#vcs_password_value").html("******"),$(this).attr("data","0"),$(this).attr("title","显示密码"),$(this).html('<i class="bk-icon icon-eye t_b t_s12" style="transform: scale(0.8,0.8);"></i>')});