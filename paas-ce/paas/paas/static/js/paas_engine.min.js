/**
* Tencent is pleased to support the open source community by making 蓝鲸智云PaaS平台社区版 (BlueKing PaaS Community Edition) available.
* Copyright (C) 2017-2018 THL A29 Limited, a Tencent company. All rights reserved.
* Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
* http://opensource.org/licenses/MIT
* Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/
$(".env_add_btn").on("click",function(){var e=['<tr class="env_record env_edit_status">','<input  type="hidden" class="server_id" disabled value="" />',"    <td>",'       <div class="env_key_box">','           <span class="s_id"></span>',"        </div>","    </td>","    <td>",'        <span class="server_token"></span>',"    </td>","    <td>",'       <input class="form-control server_ip"  value="" placeholder="请输入服务器IP"/>',"    </td>","    <td>",'       <input type="number" min="1" max="65535" class="form-control server_port"  value="4245" placeholder="请输入Agent端口"/>',"    </td>","    <td>",'       <input type="number" min="1" max="65535" class="form-control app_port"  value="8085" placeholder="请输入App服务端口"/>',"    </td>","    <td>",'       <select class="form-control server_cate"  placeholder="请选择服务器类别">','           <option value="tapp">测试服务器</option>','           <option value="app">正式服务器</option>',"       <select>","    </td>","    <td>",'        <span class="server_active">否</span>',"    </td>","    <td>",'    <button type="button" class="btn-info btn-xs env_save_btn">保存</button>','       <button type="button" class="btn-xs env_cancel_btn">取消</button> ','  <a href="###" title="编辑" class="dev_env_opera env_edit_btn"><span aria-hidden="true" class="glyphicon glyphicon-edit"></span></a>','  <a href="###" title="删除" class="dev_env_opera env_del_btn"><span aria-hidden="true" class="glyphicon glyphicon-remove-circle"></span></a>','  <a href="###" title="激活" class="dev_env_opera env_active_btn"><span aria-hidden="true" class="glyphicon glyphicon-saved"></span></a>',"    </td>","</tr>"].join("");return $("#no_record_row").hide(),$("#user_env_table").append($(e)),!1}),$("#user_env_table").on("click",".env_save_btn",function(){var e=($(this),$(this).closest(".env_record")),t=e.find(".server_ip").val(),r=e.find(".server_port").val(),i=e.find(".app_port").val(),a=e.find(".server_cate").val(),n=e.find(".server_id").val();if(!t)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请输入正确的IP地址"}).time(2),e.find(".server_ip").focus(),!1;if(!UTILS.isInt(r)||parseInt(r)<0||parseInt(r)>65535)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请输入正确的Agent端口"}).time(2),e.find(".server_port").focus(),!1;if(!UTILS.isInt(i)||parseInt(i)<0||parseInt(i)>65535)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请输入正确的App服务端口"}).time(2),e.find(".app_port").focus(),!1;if(!a)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"请选择服务器类别"}).time(2),e.find(".server_cate").focus(),!1;if(n){var s=BLUEKING.config.paas_host()+"engine/server/";$.post(s,{server_ip:t,server_port:r,app_port:i,server_cate:a,server_id:n},function(t,r){"success"==r?t.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:"保存成功"}).time(1),e.find("input").attr("disabled","disabled"),e.find("select").attr("disabled","disabled"),e.removeClass("env_edit_status")):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:t.message}):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"保存失败"})},"json")}else{var s=BLUEKING.config.paas_host()+"engine/server/";$.post(s,{server_ip:t,server_port:r,app_port:i,server_cate:a},function(t,r){"success"==r?t.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:"添加成功"}).time(1),server_data=t.data,e.find(".server_id").val(server_data.server_id),e.find(".s_id").text(server_data.s_id),e.find(".server_token").text(server_data.token),e.find("input").attr("disabled","disabled"),e.find("select").attr("disabled","disabled"),e.removeClass("env_edit_status")):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:t.message}):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:"添加失败"})},"json")}return!1}),$("#user_env_table").on("click",".env_edit_btn",function(){var e=$(this).closest(".env_record");e.addClass("env_edit_status"),e.find("input").removeAttr("disabled"),e.find("select").removeAttr("disabled");var t=e.find(".server_ip").val(),r=e.find(".server_port").val(),i=e.find(".server_cate").val(),a=e.find(".app_port").val();return e.attr("data-old-ip",t),e.attr("data-old-port",r),e.attr("data-old-cate",i),e.attr("data-old-app-port",a),!1}),$("#user_env_table").on("click",".env_cancel_btn",function(){var e=$(this).closest(".env_record");e.removeClass("env_edit_status"),e.find("input").attr("disabled","disabled"),e.find("select").attr("disabled","disabled");var t=e.attr("data-old-ip"),r=e.attr("data-old-port"),i=e.attr("data-old-cate"),a=e.attr("data-old-app-port");if(t||r||i||a){e.find(".server_ip").val(t),e.find(".server_port").val(r),e.find(".server_cate").val(i);e.find(".app_port").val(a)}else e.remove();return!1}),$("#user_env_table").on("click",".env_del_btn",function(){var e=$(this).closest(".env_record"),t=e.find(".server_id").val(),r=e.find(".server_ip").val(),i=e.find(".server_port").val(),a=e.find(".server_active").attr("data");if(t){var n=BLUEKING.config.paas_host()+"engine/server/"+t+"/",s="<div class='t_s14'>您确定删除该服务器吗?<br>IP : "+r+" , Agent端口 : "+i+"</div>",d=340;if("1"==a){var d=440;s+="<div style='color:red;margin-top: 10px;font-size: 14px;font-weight: bold;'>该服务器已经激活，删除后将不能在该机器上部署应用<br>请确认不再使用后再删除</div>"}art.dialog({title:"删除确认",width:d,icon:"question",lock:!0,content:s,ok:function(){art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:"正在进行删除操作，请稍后..."}),$.ajax({url:n,type:"DELETE",success:function(t){art.dialog({id:"bktips"}).close(),t.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:t.message}).time(1),e.remove()):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:t.message})}})},cancel:function(){},okVal:"确认删除",cancelVal:"取消"})}}),$("#user_env_table").on("click",".env_active_btn",function(){var e=$(this).closest(".env_active_btn"),t=$(this).closest(".env_record"),r=t.find(".server_id").val(),i=t.find(".server_ip").val(),a=t.find(".server_port").val();t.find(".server_active").attr("data");if(r){var n=BLUEKING.config.paas_host()+"engine/server/active/",s="<div class='t_s14'>正在检测服务器上的agent状态，请稍后....<br><br>IP : "+i+" , Agent端口 : "+a+"</div>";art.dialog({id:"bktips",width:450,height:200,icon:"face-smile",lock:!0,content:s}),$.post(n,{server_id:r},function(r){art.dialog({id:"bktips"}).close(),r.result?(art.dialog({id:"bktips",icon:"succeed",lock:!0,content:r.message}).time(1),t.find(".server_active").attr("data","1"),t.find(".server_active").text("是"),e.removeClass("env_active_btn").addClass("env_refresh_btn").html('<span aria-hidden="true" class="glyphicon  glyphicon-refresh"></span>')):art.dialog({id:"bktips",width:450,height:200,icon:"error",lock:!0,content:r.message}).time(3)},"json")}}),$("#user_env_table").on("click",".env_refresh_btn",function(){var e=$(this).closest(".env_refresh_btn"),t=$(this).closest(".env_record"),r=t.find(".server_id").val(),i=t.find(".server_ip").val(),a=t.find(".server_port").val();t.find(".server_active").attr("data");if(r){var n=BLUEKING.config.paas_host()+"engine/server/refresh/",s="<div class='t_s14'>正在刷新服务器上的agent状态，请稍后....<br><br>IP : "+i+" , Agent端口 : "+a+"</div>";art.dialog({id:"bktips",width:450,height:200,icon:"face-smile",lock:!0,content:s}),$.post(n,{server_id:r},function(r){art.dialog({id:"bktips"}).close(),r.result?(art.dialog({id:"bktips",icon:"succeed",lock:!0,content:r.message}).time(1),t.find(".server_active").attr("data","1"),t.find(".server_active").text("是"),e.removeClass("env_active_btn").addClass("env_refresh_btn").html('<span aria-hidden="true" class="glyphicon  glyphicon-refresh"></span>'),e.attr("title","刷新")):(art.dialog({id:"bktips",width:450,height:200,icon:"error",lock:!0,content:r.message}),t.find(".server_active").attr("data","0"),t.find(".server_active").text("否"),e.removeClass("env_refresh_btn").addClass("env_active_btn").html('<span aria-hidden="true" class="glyphicon glyphicon-saved"></span>'),e.attr("title","激活"))},"json")}});